---
title: "Untitled"
author: "Чайка З.С,"
date: "2024-04-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DescTools)
library(tidyverse)
library(qqplotr)
library(psych)
library(dplyr)
library(ggplot2)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
set.seed(123)

# Задаем размер выборки
sample_size <- 30

# Задаем значения среднего артериального давления до и после приема нового препарата
before <- rnorm(sample_size, mean = 170, sd = 10)  # значния до приема нового препарата, среднее 140, стандартное отклонение 10
after <- rnorm(sample_size, mean = 120, sd = 8)    # значения после приема нового препарата, среднее 130, стандартное отклонение 8
# Создание объекта data.frame
data <- data.frame(before, after)
data
```



```{r}
#Нулевая и альтернативная гипотезы для данного случая можно сформулировать следующим образом:

#Нулевая гипотеза (H0): Среднее артериальное давление до и после приема нового препарата одинаковое

#Альтернативная гипотеза (H1): Среднее артериальное давление после приема нового препарата меньше, чем до приема.

#Уровень значимости (α) - это вероятность совершения ошибки первого рода, то есть вероятность отвергнуть нулевую гипотезу, когда она на самом деле верна. Обычно уровень значимости выбираем равным 0.05. Это означает, что если p-value (вероятность получить наблюдаемые данные или более экстремальные при условии, что нулевая гипотеза верна) окажется меньше 0.05, то мы отвергаем нулевую гипотезу в пользу альтернативной.
#Для проверки гипотезы о разнице средних в двух связанных выборках (до и после приема препарата) мы будем использовать парный двухвыборочный t-критерий для связанных выборок (paired samples t-test).

#Я выбирала этот тест, потому что у нас есть две зависимые выборки из одной группы пациентов (до и после приема препарата), и я хочу определить, есть ли статистически значимое различие между средними значениями внутри этой группы.

#При этом t-критерий для связанных выборок учитывает корреляцию между парами наблюдений до и после, что позволяет более точно оценить статистическую значимость различий.

#Несмотря на то, что я изначально генерировала выборку с нормально распределенными данными, я хочу проверить эти данные на нормальность распределения. Из учебного модуля, мы знаем, что необходимо делать 2 проверки данных на нормальность: с использованием графическх методов и с помощью статистических тестов Shapiro-Wilk и Колмогорова-смирнова. При этом, необходимо помнить, что графические тесты при малом количестве наблюдений могут смутно указывать на нормальность распределения.

# Строим QQ-графики. (квантиль-квантиль графики) для каждой выборки. Они позволят сравнить квантили выборки с теоретическими квантилями нормального распределения.Если данные соответствуют нормальному распределению, точки на графиках должны следовать прямой линии под углом 45 градусов
ggplot(data, aes(sample = before)) +
stat_qq() +
ggtitle("Before Treatment QQ Plot")

ggplot(data, aes(sample = after)) +
stat_qq() +
ggtitle("After Treatment QQ Plot")
```
```{r}
#Гистограммы Также позволяют визуально оценить форму распределения данных и проверить их на нормальность
par(mfrow=c(1,2)) # Разбиваем окно на две части для двух гистограмм
hist(data$before, main="Before Treatment Histogram", xlab="Arterial Pressure")
hist(data$after, main="After Treatment Histogram", xlab="Arterial Pressure")
```
```{r}
#Согласно результатам теста Шапиро-Уилка, мы не можем отвергнуть нулевую гипотезу. А согласно результатам теста Колмогорова-Смирнова - можем (возможно, полученные результаты связаны с тем, что этот тест очень чувствителен к отклонениям в "хвостах распределения")
shapiro.test(data$before)
ks.test(data$before , "pnorm")
shapiro.test(data$after)
ks.test(data$after, "pnorm")
```
```{r}
#Для проверки гипотезы о разнице средних в двух связанных выборках (до и после приема препарата) мы будем использовать парный двухвыборочный t-критерий для связанных выборок (paired samples t-test).
#Результаты теста указывают на наличие разницы средних в двух связанных выборках (согласно данным p-value < 2.2e-16, мы не можем принять Н0, поэтому принимаем Альтернативную гипотезу.)
# Проведение парного t-теста
result <- t.test(before, after, paired=TRUE)
result
# Вычисление критического значения t-статистики для парного t-теста
alpha <- 0.05  # Уровень значимости
df <- 29  # Количество степеней свободы

critical_value <- qt(1 - alpha/2, df)  # Критическое значение t-статистики
print(critical_value)

#Наблюдаемое значение статистики для парного t-теста составляет t = 20.731. Для проведения теста было получено значение количества степеней свободы (df) равное 29, p-значение менее чем 2.2e-16.

#Критическое значение статистики для парного t-теста зависит от уровня значимости (alpha) и количества степеней свободы. Для двустороннего теста на уровне значимости 0.05 и 29 степеней свободы, критическое значение t-статистики составляет приблизительно 2.04523.

#Полученное наблюдаемое значение статистики t = 20.731 гораздо больше критического значения 2.045. Это говорит о том, что наблюдаемое различие средних является статистически значимым на уровне значимости 0.05. Другими словами, есть значительные доказательства против нулевой гипотезы, что средние значения до и после теста одинаковы. Таким образом, можно сделать вывод о статистической значимости различия между группами.

#95% доверительный интервал для разности средних составляет (43.35665, 52.84786), что говорит о том, что среднее значение разности между before и after лежит в этом интервале с вероятностью 95%.
```
```{r}
##Задание 2
# Вероятность заболеть раком для курящих и некурящих

set.seed(123)# Установка seed для воспроизводимости
# Задаем общий размер выборки

sample_size1 <- 100
sample_size2 <- 30
# Генерируем фактор курения (курящие - 1, некурящие - 0)
smoking1 <- c(rep(1, sample_size1/2), rep(0, sample_size1/2))
smoking2 <- c(rep(1, sample_size2/2), rep(0, sample_size2/2))

# Устанавливаем вероятность заболеть раком для каждой группы
prob1 <- ifelse(smoking1 == 1, 0.8, 0.2)
prob2 <- ifelse(smoking2 == 1, 0.8, 0.2)

# Генерируем выборку для заболевших раком на основе биномиального распределения
cancer1 <- rbinom(sample_size1, size = 1, prob1)
cancer2 <- rbinom(sample_size2, size = 1, prob2)

# Создаем датафрейм из сгенерированных данных
data1 <- data.frame(smoking1 = factor(smoking1, labels = c("non-smoker", "smoker")), cancer1 = factor(cancer1, labels = c("no", "yes")))
data2 <- data.frame(smoking2 = factor(smoking2, labels = c("non-smoker", "smoker")), cancer2 = factor(cancer2, labels = c("no", "yes")))
# Выводим первые строки датафрейма
data1
table(data1)
data2
table(data2)
```
```{r}
#Нулевая и альтернативная гипотезы для данного случая можно сформулировать следующим образом:

#Нулевая гипотеза (H0): Заболеть раком легких в одинаковой степени могут как  курильщики, так и те, кто не курят.

#Альтернативная гипотеза (H1): У курильщиков  вероятность заболеть раком легких выше, чем у тех, кто не курит.

#Уровень значимости (α) - это вероятность совершения ошибки первого рода, то есть вероятность отвергнуть нулевую гипотезу, когда она на самом деле верна. Обычно уровень значимости выбираем равным 0.05. Это означает, что если p-value (вероятность получить наблюдаемые данные или более экстремальные при условии, что нулевая гипотеза верна) окажется меньше 0.05, то мы отвергаем нулевую гипотезу в пользу альтернативной.
#Для проверки гипотезы о разнице категориальных признаков,  мы будем использовать точный тест Фишера, поскольку он хорошо работает на малом числе наблюдений и позволяетт получать более аккуратный анализ для маленьких выборок

fisher.test(x = data1$cancer1, y = data1$smoking1)
fisher.test(x = data2$cancer2, y = data2$smoking2)
```
```{r}
#Снова расчитываем тест Фишера и результаты из первой выборки записываем в result1. 

# Для первой выборки (sample_size1 <- 100) мы получили статистически значимую связь между переменными, на это указывает низкий p-value (отвергает Н0) и отношение шансов odds ratio (20.84573), говорит, что у курящих людей в 21 раз больше шансов заболеть раком легких.
result1 <- fisher.test(table(data1$cancer1, data1$smoking1))
result1
# Получение наблюдаемого значения статистики
observed_statistic1 <- result1$estimate

# Получение критического значения статистики
# Задаем уровень значимости alpha
alpha <- 0.05  # например, 5% (обычно используется 0.05)

# Задаем количество строк и столбцов в таблице сопряженности
n_rows1 <- nrow(table(data1$cancer1, data1$smoking1))
n_cols1 <- ncol(table(data1$cancer1, data1$smoking1))

# Рассчитываем критическое значение статистики
critical_value1 <- qchisq(alpha, n_rows1, n_cols1)

# Вывод значений
observed_statistic1
critical_value1

#Для нахождения критического значения я использовала функцию qchisq() для заданного уровня значимости и количества степеней свободы (в данном случае - 1), потому что обычно критические значения для теста Фишера рассчитыаются на основе таблиц критических значений распределения Хи-квадрат с 1 степенью свободы.
```
```{r}
#Снова расчитываем тест Фишера и результаты из второй выборки записываем в result2 

# Для первой выборки (sample_size2 <- 30) мы получили статистически значимую связь между переменными, на это указывает низкий p-value (отвергает Н0) и отношение шансов odds ratio (11.71205), говорит, что у курящих людей в 11 раз больше шансов заболеть раком легких.
result2 <- fisher.test(table(data2$cancer2, data2$smoking2))
result2
# Получение наблюдаемого значения статистики
observed_statistic2 <- result2$estimate

# Получение критического значения статистики
# Задаем уровень значимости alpha
alpha <- 0.05  # например, 5% (обычно используется 0.05)

# Задаем количество строк и столбцов в таблице сопряженности
n_rows2 <- nrow(table(data2$cancer2, data2$smoking2))
n_cols2 <- ncol(table(data2$cancer2, data2$smoking2))

# Рассчитываем критическое значение статистики
critical_value2 <- qchisq(alpha, n_rows2, n_cols2)

# Вывод значений
observed_statistic2
critical_value2

#Для нахождения критического значения я использовала функцию qchisq() для заданного уровня значимости и количества степеней свободы (в данном случае - 1), потому что обычно критические значения для теста Фишера рассчитыаются на основе таблиц критических значений распределения Хи-квадрат с 1 степенью свободы.
#Полученное наблюдаемое значение статистики в двух выборках гораздо больше критического значения 0.2722299. Это говорит о том, что наблюдаемое различия являются статистически значимыми на уровне значимости 0.05. Другими словами, есть значительные доказательства против нулевой гипотезы. 
```
```{r}
#Задание 3
#Создаем дата сет с распределением Пуатсона, поскольку болевой симптом будем определять по шкале от 1 до 10, а это дискретная величина.
```

```{r}
set.seed(123)

# Создание уровня болевых симптомов в контрольной группе (диетотерапия) с распределением Пуассона
control_group <- rpois(n = 100, lambda = 5)

# Создание уровня болевых симптомов в тестовой группе (новый метод лечения) с распределением Пуассона и смещенным параметром lambda
treatment_group <- rpois(n = 100, lambda = 3)

# Создание датафрейма 
df <- data.frame(group = c(rep("Control", 100), rep("Treatment", 100)), pain_level = c(control_group, treatment_group))
df
```
```{r}
# Для наглядности строим график.По графику видим, что при применении нового препарата, болевой синдром снизился значительно по сравнению с пациентами с диетотерапией.
ggplot(df, aes(x = pain_level, fill = group)) + 
  geom_histogram(position = "identity", alpha = 0.7, bins = 30) +
  labs(title = "Распределение болевых симптомов",
       x = "Уровень болевых симптомов",
       y = "Частота") +
  scale_fill_manual(values = c("red", "yellow"), labels = c("control_group", "treatment_group"))
```
```{r}
# Тест Манна-Уитни (аналог двухвыборочного t-теста Стьюдента для непараметрических данных) применяем для проверки статистический значимости проверяемой гипотезы.
# Н0 никаких различий в группах нет и уровень болевых ощущений не изменился. 
#Н1 есть достоверные различия в группах
#Уровень значимости (α) - это вероятность совершения ошибки первого рода, то есть вероятность отвергнуть нулевую гипотезу, когда она на самом деле верна. Обычно уровень значимости выбираем равным 0.05. Это означает, что если p-value (вероятность получить наблюдаемые данные или более экстремальные при условии, что нулевая гипотеза верна) окажется меньше 0.05, то мы отвергаем нулевую гипотезу в пользу альтернативной.
# В результате выполнения теста, получили статистически значимые различия в группах, на это указывает низкий p-value (отвергает Н0) и W (7672), говорит, что есть статистически значимая разница между двумя группами.
wilcox_test_result <- wilcox.test(pain_level ~ group, data = df)
print(wilcox_test_result)
```
```{r}
df2 <- data.frame(substance = c(rep("A", 3), rep("B", 3), rep("C", 3)), concentration = rep(c("I", "II", "III"), 3),                true_response = c(0.6, 0.65, 0.5, 0.8, 0.95, 0.7, 0.7, 0.6, 0.8))
df2 <- df2%>%
mutate(observed_response = rbinom(n(), 25, true_response)) %>%   select(-true_response)
df2
```
```{r}
# Создание графика
# Попробовала через ggplot, но не полчается, не понимаю почему они вытягиваются в одну линию.
# Ниже попробовала другой код.
ggplot(df2, aes(x = substance,y = observed_response,  fill = concentration)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(title = "Распределение observed_response по препаратам и концентрациям",
       x = "Препарат", y = "Наблюдаемые ответы")
```
```{r}
# Создание графика.
# таким образом получилось. Возможно это и имелось ввиду в задании.
boxplot(  observed_response ~ substance, data = df2)
boxplot(  observed_response ~ concentration, data = df2)

```
```{r}
# Применяем двухфакторный дисперсионный анализ ANOVA для проверки статистически значимых различий в средних значениях observed_response в зависимости от препарата и концентрации. 
# Н0 никаких различий в группах нет
#Н1 есть достоверные различия в observed_responsе в зависимости от препарата и концентрации.
#Уровень значимости (α) - это вероятность совершения ошибки первого рода, то есть вероятность отвергнуть нулевую гипотезу, когда она на самом деле верна. Обычно уровень значимости выбираем равным 0.05. Это означает, что если p-value (вероятность получить наблюдаемые данные или более экстремальные при условии, что нулевая гипотеза верна) окажется меньше 0.05, то мы отвергаем нулевую гипотезу в пользу альтернативной.
model <- aov(observed_response ~ substance * concentration, data = df2)
summary(model)
#Для substance сумма квадратов говорит о значимом влиянии этого фактора на зависимую переменную.
#Для concentration сумма квадратов, также говорит о значимом влиянии этого фактора на зависимую переменную.
#Взаимодействие substance b  concentration, также говорит о значимом влиянии этого фактора на зависимую переменную.
```
```{r}
# Без поправок
pairwise.t.test(df2$observed_response, df2$substance, p.adjust.method = "none")

# С поправкой Бонферони
pairwise.t.test(df2$observed_response, df2$substance, p.adjust.method = "bonferroni")

# С поправкой Холма
pairwise.t.test(df2$observed_response, df2$substance, p.adjust.method = "holm")
```
```{r}
# Без поправок
pairwise.t.test(df2$observed_response, df2$concentration, p.adjust.method = "none")

# С поправкой Бонферони
pairwise.t.test(df2$observed_response, df2$concentration, p.adjust.method = "bonferroni")

# С поправкой Холма
pairwise.t.test(df2$observed_response, df2$concentration, p.adjust.method = "holm")
```


